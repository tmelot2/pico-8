pico-8 cartridge // http://www.pico-8.com
version 41
__lua__

screenwidth = 127
screenheight = 127

MAZE_SIZE=32
TILE_SIZE=4

maze={}
t=0

p={}
anim={}

-- main
function _init()
	t=0
	maze=initmaze()
	p=initplayer()

	-- set key delay
	poke(0x5f5c, 10)
end

function _update60()	
	t+=1
	input()
	animate()
	updateplayer()
	adddebug('#anim '..#anim)
end

function _draw()
	cls(0)

	-- maze
	for ix,x in ipairs(maze) do
		for iy,y in ipairs(x) do
			if y==true then
				sspr(8,0, 4,4, TILE_SIZE*(ix-1),TILE_SIZE*(iy-1))
			end
		end
	end

	-- player
	sspr(8,8, 4,4, p.x,p.y)
	-- adddebug('p.mx '..p.mx)
	-- adddebug('p.my '..p.my)
	-- adddebug('p.x '..p.x)
	-- adddebug('p.y '..p.y)

	drawdebug()
end


-- maze
function initmaze()
	m={}
	for x=1,MAZE_SIZE do
		m[x] = {}
		for y=1,MAZE_SIZE do
			-- ignore perimeter
			if x==1 or x==MAZE_SIZE or y==1 or y==MAZE_SIZE then 
				wall=true 
			-- middle
			else
				wall=true
				-- if frnd(100)<10 then wall=true end
			end
			m[x][y] = wall
		end
	end

	-- carve hallways
	for carves=1,frnd(15)+20 do
		-- horizontal
		x=frnd(MAZE_SIZE-1)+2
		y=frnd(MAZE_SIZE-1)+2
		l=frnd(15)+5
		if x+l > MAZE_SIZE-1 then l=MAZE_SIZE-x-2 end
		if x<1 then x=1 end
		for i=1,l do
			m[x+i][y]=false
		end
		
		-- vertical
		x=frnd(MAZE_SIZE-1)+2
		y=frnd(MAZE_SIZE-1)+2
		l=frnd(15)+5
		if y+l > MAZE_SIZE-1 then l=MAZE_SIZE-y-2 end
		if y<1 then y=1 end
		for i=1,l do
			m[x][y+i]=false
		end
	end

	-- carve random tiles
	for tiles=1,frnd(60)+15 do
		x=frnd(MAZE_SIZE-1)+1
		y=frnd(MAZE_SIZE-1)+1
		wall=m[x][y]
		while wall==false do
			printh('WALL ALREADY MISSING, RE RANDOMIZING', 'log')
			x=frnd(MAZE_SIZE-1)+1
			y=frnd(MAZE_SIZE-1)+1
			wall=m[x][y]
		end
		m[x][y]=false
	end

	return m
end


-- player
function initplayer()
	mx=frnd(20)
	my=frnd(20)
	return {
		mx=mx, my=my,
		x=TILE_SIZE*(mx-1),y=TILE_SIZE*(my-1)
	}
end

function updateplayer()
end

function moveplayer(mazex, mazey)
	dur=8
	if getmazewall(mazex,mazey) == false then 
		sx=p.x
		sy=p.y

		p.mx=mazex
		p.my=mazey

		ax=newAnimation(
			'player.x',
			p, 'x',
			sx, TILE_SIZE*(p.mx-1),
			0, dur,
			easequarticout
		)
		ay=newAnimation(
			'player.y',
			p, 'y',
			sy, TILE_SIZE*(p.my-1),
			0, dur,
			easequarticout
		)
		add(anim,ax)
		add(anim,ay)
	end
end


-- animation
-- id, object, prop, start val, end val, time, duration, easing func
function newAnimation(id,o,prop,s,e,t,d,f)
	-- if anim exists, start from current place, reset timer
	a=getAnimation(id)
	if a ~= nil then
		a.s=o[prop]
		a.e=e
		a.t=0
		a.d=d
		a.f=f
	else
		a={
			id=id,
			obj=o, prop=prop,
			s=s, e=e,
			t=0, d=dur,
			f=f
		}
		add(anim,a)
	end
end

function getAnimation(id)
	for i,a in ipairs(anim) do
		if a.id == id then
			return anim[i]
		end
	end
	return nil
end


function animate()
	for a in all(anim) do
		if a.t>=a.d then
			del(anim,a)
		end
		percent = a.t/a.d
		val = ease(percent, a.s, round(a.e-a.s), a.f)
		a.obj[a.prop] = val
		a.t+=1
	end
end


-- input
function input()
	if btnp(0) then
		moveplayer(p.mx-1, p.my)
	end
	if btnp(1) then
		moveplayer(p.mx+1, p.my)
	end
	if btnp(2) then
		moveplayer(p.mx, p.my-1)
	end
	if btnp(3) then
		moveplayer(p.mx, p.my+1)
	end

	if btnp(4) then
		nx = frnd(20+10)+1
		ny = frnd(20+10)+1
		moveplayer(nx,ny)
	end

	if btn(5) then maze=initmaze() end

	c = maze[p.mx][p.my]
end


-- util
function round(x)
	if ceil(x)-x >= 0.5 then
		return ceil(x)
	else
		return flr(x)
	end
end

function frnd(x)
	return flr(rnd(x))
end

-- 1 based
function getmazewall(x,y)
	print('getmazewall '..x..' '..y)
	if x<=1 or x>=MAZE_SIZE or y<=1 or y>=MAZE_SIZE then return true end
	return maze[x][y]
end

dbg={}
function drawdebug()
	local i=0
	for i,d in ipairs(dbg) do
		print(d, 1, i*7, 7)
	end
	-- print('fps '..stat(7), 1, i*7, 7)
	dbg={}
end
function adddebug(d)
	dbg[#dbg+1] = d
end

-- percent, start, end (offset from start), ease func
function ease(percent,s,e,f)
	return s + (e)*f(percent)
end
function easelinear(t)
	return t
end
function easecubicout(t)
	return 1 - (1-t)^3
end
function easequarticout(t)
	return 1 - (1-t)^4
end
function easeexpout(t)
	if t==1 then return 1 end
	return 1 - 2^(-10*t)
end

__gfx__
00000000222122221221122118810000111112210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000222122222882299282280000122112210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700222122222882299282280000122112210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000111011111221122118810000122111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000212222221441133100000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700212222224aa43bb300000000122212210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000212222224aa43bb300000000122212210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111111441133100000000111112210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000aaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000abba00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000abba00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000aaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
